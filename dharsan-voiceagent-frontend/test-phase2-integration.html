<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .status-card.success {
            border-left-color: #28a745;
        }
        .status-card.error {
            border-left-color: #dc3545;
        }
        .status-card.warning {
            border-left-color: #ffc107;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Phase 2 Integration Test</h1>
    
    <div class="test-section">
        <h2>Backend Services Status</h2>
        <div id="backend-status" class="status-grid">
            <div class="status-card">
                <h4>Media Server (Go)</h4>
                <p>Port: 8080</p>
                <p id="media-server-status">Checking...</p>
            </div>
            <div class="status-card">
                <h4>Orchestrator (Go)</h4>
                <p>Port: 8001</p>
                <p id="orchestrator-status">Checking...</p>
            </div>
            <div class="status-card">
                <h4>Redpanda (Kafka)</h4>
                <p>Port: 9092</p>
                <p id="redpanda-status">Checking...</p>
            </div>
            <div class="status-card">
                <h4>Frontend Dev Server</h4>
                <p>Port: 5173</p>
                <p id="frontend-status">Checking...</p>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Integration Tests</h2>
        <div id="test-results">
            <p class="info">Running integration tests...</p>
        </div>
        <div class="status-grid">
            <div class="status-card">
                <h4>WHIP Protocol</h4>
                <p id="whip-test">Pending</p>
            </div>
            <div class="status-card">
                <h4>WebSocket Connection</h4>
                <p id="websocket-test">Pending</p>
            </div>
            <div class="status-card">
                <h4>AI Pipeline</h4>
                <p id="ai-pipeline-test">Pending</p>
            </div>
            <div class="status-card">
                <h4>Audio Streaming</h4>
                <p id="audio-test">Pending</p>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Manual Testing</h2>
        <p>Click the buttons below to test different aspects of the Phase 2 integration:</p>
        <button onclick="testWHIPConnection()">Test WHIP Connection</button>
        <button onclick="testWebSocketConnection()">Test WebSocket</button>
        <button onclick="testAIPipeline()">Test AI Pipeline</button>
        <button onclick="testAudioStreaming()">Test Audio Streaming</button>
        <button onclick="openV2Phase2()">Open V2 Phase 2</button>
    </div>

    <div class="test-section">
        <h2>Live Preview</h2>
        <p>Current route: <span id="current-route">/</span></p>
        <iframe id="preview-frame" src="http://localhost:5173/"></iframe>
    </div>

    <div class="test-section">
        <h2>Test Logs</h2>
        <div id="test-logs" class="log-container"></div>
    </div>

    <script>
        const testResults = document.getElementById('test-results');
        const currentRouteSpan = document.getElementById('current-route');
        const previewFrame = document.getElementById('preview-frame');
        const testLogs = document.getElementById('test-logs');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            testLogs.appendChild(logEntry);
            testLogs.scrollTop = testLogs.scrollHeight;
        }

        function updateTestResults(message, type = 'info') {
            const p = document.createElement('p');
            p.className = type;
            p.textContent = message;
            testResults.appendChild(p);
        }

        function updateStatus(elementId, status, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = status;
                element.className = type;
            }
        }

        function updateStatusCard(cardId, status, type = 'info') {
            const card = document.getElementById(cardId);
            if (card) {
                card.className = `status-card ${type}`;
                const statusElement = card.querySelector('p:last-child');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }
        }

        async function checkBackendServices() {
            log('Checking backend services...');
            
            // Check Media Server
            try {
                const mediaResponse = await fetch('http://localhost:8080/health');
                if (mediaResponse.ok) {
                    const data = await mediaResponse.json();
                    updateStatusCard('media-server-status', 'Running', 'success');
                    log(`✅ Media Server: ${data.status || 'healthy'}`);
                } else {
                    updateStatusCard('media-server-status', 'Error', 'error');
                    log(`❌ Media Server: HTTP ${mediaResponse.status}`);
                }
            } catch (error) {
                updateStatusCard('media-server-status', 'Not Running', 'error');
                log(`❌ Media Server: ${error.message}`);
            }

            // Check Orchestrator
            try {
                const orchestratorResponse = await fetch('http://localhost:8001/health');
                if (orchestratorResponse.ok) {
                    updateStatusCard('orchestrator-status', 'Running', 'success');
                    log('✅ Orchestrator: Running');
                } else {
                    updateStatusCard('orchestrator-status', 'Error', 'error');
                    log(`❌ Orchestrator: HTTP ${orchestratorResponse.status}`);
                }
            } catch (error) {
                updateStatusCard('orchestrator-status', 'Not Running', 'error');
                log(`❌ Orchestrator: ${error.message}`);
            }

            // Check Frontend
            try {
                const frontendResponse = await fetch('http://localhost:5173/');
                if (frontendResponse.ok) {
                    updateStatusCard('frontend-status', 'Running', 'success');
                    log('✅ Frontend: Running');
                } else {
                    updateStatusCard('frontend-status', 'Error', 'error');
                    log(`❌ Frontend: HTTP ${frontendResponse.status}`);
                }
            } catch (error) {
                updateStatusCard('frontend-status', 'Not Running', 'error');
                log(`❌ Frontend: ${error.message}`);
            }

            // Check Redpanda (simplified)
            updateStatusCard('redpanda-status', 'Check Docker', 'warning');
            log('⚠️ Redpanda: Check if Docker is running and Redpanda container is started');
        }

        async function testWHIPConnection() {
            log('Testing WHIP connection...');
            updateStatusCard('whip-test', 'Testing...', 'warning');
            
            try {
                // Create a proper WebRTC SDP offer for testing
                const sdpOffer = `v=0
o=- 1234567890 2 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
m=audio 9 UDP/TLS/RTP/SAVPF 111
c=IN IP4 0.0.0.0
a=mid:0
a=sendonly
a=rtpmap:111 opus/48000/2
a=fmtp:111 minptime=10;useinbandfec=1
a=rtcp-fb:111 nack
a=rtcp-fb:111 nack pli
a=rtcp-fb:111 ccm fir
a=extmap:1 urn:ietf:params:rtp-hdrext:toffset
a=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:3 urn:3gpp:video-orientation
a=extmap:4 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01
a=extmap:5 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay
a=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/video-content-type
a=extmap:7 http://www.webrtc.org/experiments/rtp-hdrext/video-timing
a=extmap:8 http://www.webrtc.org/experiments/rtp-hdrext/color-space
a=extmap:9 urn:ietf:params:rtp-hdrext:sdes:mid
a=extmap:10 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id
a=extmap:11 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id
a=ice-pwd:testpassword123
a=ice-ufrag:testuser
a=fingerprint:sha-256 testfingerprint123
a=setup:actpass
a=connection:new`;

                const response = await fetch('http://localhost:8080/whip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/sdp',
                    },
                    body: sdpOffer
                });
                
                if (response.ok) {
                    updateStatusCard('whip-test', 'Success', 'success');
                    log('✅ WHIP connection test successful');
                } else {
                    updateStatusCard('whip-test', 'Failed', 'error');
                    log(`❌ WHIP connection test failed: ${response.status}`);
                }
            } catch (error) {
                updateStatusCard('whip-test', 'Error', 'error');
                log(`❌ WHIP connection test error: ${error.message}`);
            }
        }

        async function testWebSocketConnection() {
            log('Testing WebSocket connection...');
            updateStatusCard('websocket-test', 'Testing...', 'warning');
            
            try {
                const ws = new WebSocket('ws://localhost:8001/ws');
                
                ws.onopen = () => {
                    updateStatusCard('websocket-test', 'Connected', 'success');
                    log('✅ WebSocket connection successful');
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    updateStatusCard('websocket-test', 'Failed', 'error');
                    log(`❌ WebSocket connection failed: ${error}`);
                };
                
                setTimeout(() => {
                    if (ws.readyState !== WebSocket.OPEN) {
                        updateStatusCard('websocket-test', 'Timeout', 'error');
                        log('❌ WebSocket connection timeout');
                    }
                }, 5000);
            } catch (error) {
                updateStatusCard('websocket-test', 'Error', 'error');
                log(`❌ WebSocket test error: ${error.message}`);
            }
        }

        async function testAIPipeline() {
            log('Testing AI Pipeline...');
            updateStatusCard('ai-pipeline-test', 'Testing...', 'warning');
            
            try {
                // Test if orchestrator is responding
                const response = await fetch('http://localhost:8001/health');
                if (response.ok) {
                    updateStatusCard('ai-pipeline-test', 'Available', 'success');
                    log('✅ AI Pipeline: Orchestrator is available');
                } else {
                    updateStatusCard('ai-pipeline-test', 'Unavailable', 'error');
                    log('❌ AI Pipeline: Orchestrator not responding');
                }
            } catch (error) {
                updateStatusCard('ai-pipeline-test', 'Error', 'error');
                log(`❌ AI Pipeline test error: ${error.message}`);
            }
        }

        async function testAudioStreaming() {
            log('Testing Audio Streaming...');
            updateStatusCard('audio-test', 'Testing...', 'warning');
            
            try {
                // Test if media server accepts audio
                const response = await fetch('http://localhost:8080/');
                if (response.ok) {
                    updateStatusCard('audio-test', 'Ready', 'success');
                    log('✅ Audio Streaming: Media server is ready');
                } else {
                    updateStatusCard('audio-test', 'Not Ready', 'error');
                    log('❌ Audio Streaming: Media server not responding');
                }
            } catch (error) {
                updateStatusCard('audio-test', 'Error', 'error');
                log(`❌ Audio Streaming test error: ${error.message}`);
            }
        }

        function openV2Phase2() {
            currentRouteSpan.textContent = '/v2/phase2';
            previewFrame.src = 'http://localhost:5173/v2/phase2';
            log('Opening V2 Phase 2 dashboard...');
        }

        function testRoute(route) {
            currentRouteSpan.textContent = route;
            previewFrame.src = `http://localhost:5173${route}`;
            log(`Testing route: ${route}`);
        }

        // Run initial tests
        async function runTests() {
            log('Starting Phase 2 integration tests...');
            updateTestResults('Starting Phase 2 integration tests...', 'info');
            
            // Check backend services
            await checkBackendServices();
            
            // Run integration tests
            await testWHIPConnection();
            await testWebSocketConnection();
            await testAIPipeline();
            await testAudioStreaming();
            
            updateTestResults('✅ Phase 2 integration tests completed!', 'success');
            updateTestResults('Next steps: Start backend services and test full conversation flow', 'info');
        }

        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html> 